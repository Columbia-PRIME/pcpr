<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Quick start: applying PCP to a simulated environmental mixture • pcpr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Quick start: applying PCP to a simulated environmental mixture">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pcpr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart-sim-example.html">Quick start: applying PCP to a simulated environmental mixture</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Columbia-PRIME/pcpr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Quick start: applying PCP to a simulated environmental mixture</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Columbia-PRIME/pcpr/blob/main/vignettes/quickstart-sim-example.Rmd" class="external-link"><code>vignettes/quickstart-sim-example.Rmd</code></a></small>
      <div class="d-none name"><code>quickstart-sim-example.Rmd</code></div>
    </div>

    
    
<p>The R package <code>pcpr</code> implements Principal Component
Pursuit (PCP), a robust dimensionality reduction technique, for pattern
recognition tailored to environmental health data. The statistical
methodology and computational details are provided in <a href="https://doi.org/10.1289/EHP10479" class="external-link">Gibson et al. (2022)</a>.</p>
<p>In this vignette, we will see how to leverage the functions in
<code>pcpr</code> to:</p>
<ol style="list-style-type: decimal">
<li>Simulate and explore a simple environmental mixture dataset;</li>
<li>Determine the best PCP algorithm to employ with the simulated
data;</li>
<li>Tune PCP’s parameters using a cross-validated grid search; and</li>
<li>Evaluate PCP’s performance against the simulated ground truth
mixture model.</li>
</ol>
<div class="section level2">
<h2 id="preliminaries">Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"></a>
</h2>
<div class="section level3">
<h3 id="pcp-modeling-overview">PCP modeling overview<a class="anchor" aria-label="anchor" href="#pcp-modeling-overview"></a>
</h3>
<p>PCP algorithms model an observed exposure matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>
as the sum of three underlying ground-truth matrices:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder><msub><mi>D</mi><mrow><mi>n</mi><mo>×</mo><mi>p</mi></mrow></msub><mtext mathvariant="normal">mixture</mtext></munder><mo>=</mo><munder><msub><mi>L</mi><mn>0</mn></msub><mtext mathvariant="normal">low-rank</mtext></munder><mo>+</mo><munder><msub><mi>S</mi><mn>0</mn></msub><mtext mathvariant="normal">sparse</mtext></munder><mo>+</mo><munder><msub><mi>Z</mi><mn>0</mn></msub><mtext mathvariant="normal">noise</mtext></munder></mrow><annotation encoding="application/x-tex">\underset{\text{mixture}}{D_{n \times p}} = \underset{\text{low-rank}}{L_0} + \underset{\text{sparse}}{S_0} + \underset{\text{noise}}{Z_0}</annotation></semantics></math></p>
<p>a low-rank matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>L</mi><mn>0</mn></msub><annotation encoding="application/x-tex">L_0</annotation></semantics></math>
encoding consistent patterns of exposure, a sparse matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mn>0</mn></msub><annotation encoding="application/x-tex">S_0</annotation></semantics></math>
isolating unique or outlying exposure events (that cannot be explained
by the consistent exposure patterns), and dense noise
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Z</mi><mn>0</mn></msub><annotation encoding="application/x-tex">Z_0</annotation></semantics></math>.
All of these matrices are of dimension
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>p</mi></mrow><annotation encoding="application/x-tex">n \times p</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
is the number of observations (e.g. study participants or measurement
dates) and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
is the number of exposures (e.g. chemical and/or non-chemical
stressors). Beyond this mixtures model, the main assumption made by PCP
is that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mn>0</mn></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo>,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Z_0 \sim N(\mu, \sigma^2)</annotation></semantics></math>
consists of i.i.d. Gaussian noise corrupting each entry of the overall
exposure matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>D</mi><annotation encoding="application/x-tex">D</annotation></semantics></math>.</p>
<p>The models in <code>pcpr</code> seek to decompose an observed data
matrix <code>D</code> into estimated low-rank and sparse components
<code>L</code> and <code>S</code> for use in downstream environmental
health analyses.</p>
</div>
<div class="section level3">
<h3 id="extensions-for-environmental-health-data">Extensions for environmental health data<a class="anchor" aria-label="anchor" href="#extensions-for-environmental-health-data"></a>
</h3>
<p>The functions in <code>pcpr</code> are outfitted with three
environmental health (EH)-specific extensions, making <code>pcpr</code>
particularly powerful for EH research:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Missing value functionality:</strong> PCP is able to recover
<code>NA</code> values in the observed mixture matrix, often
outperforming traditional imputation techniques.</li>
<li>
<strong>Leveraging potential limit of detection (LOD)
information:</strong> When equipped with LOD information, PCP treats any
estimations of values known to be below the LOD as equally valid if
their approximations fall between 0 and the LOD. PCP with LOD data often
outperforms PCA imputed with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><mi>L</mi><mi>O</mi><mi>D</mi></mrow><msqrt><mn>2</mn></msqrt></mfrac><annotation encoding="application/x-tex">\frac{LOD}{\sqrt{2}}</annotation></semantics></math>.</li>
<li>
<strong>Non-negativity constraint on the estimated <code>L</code>
matrix:</strong> If desired, PCP can enforce values in the estimated
low-rank matrix <code>L</code> to be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\geq 0</annotation></semantics></math>,
better modeling real world mixtures data.</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="simulated-environmental-mixture-example">Simulated environmental mixture example<a class="anchor" aria-label="anchor" href="#simulated-environmental-mixture-example"></a>
</h2>
<p>We start by loading and attaching the <code>pcpr</code> package to
our current R session.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Columbia-PRIME/pcpr" class="external-link">pcpr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="simulating-data">Simulating data<a class="anchor" aria-label="anchor" href="#simulating-data"></a>
</h3>
<p>The <code><a href="../reference/sim_data.html">sim_data()</a></code> function lets users generate simple
mixtures models for quick experimentation. Let’s use it to simulate a
noisy environmental mixture comprised of 100 observations of 10
chemicals, with three underlying chemical exposure patterns (or a rank
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">r = 3</annotation></semantics></math>),
extreme outlying exposure events along the diagonal of the matrix, and
dense Gaussian noise corrupting all the measurements in the matrix:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Columbia-PRIME/pcpr" class="external-link">pcpr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_data.html">sim_data</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">100</span>, p <span class="op">=</span> <span class="fl">10</span>, r <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  sparse_nonzero_idxs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span>, <span class="fl">101</span><span class="op">)</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">0.05</span></span>
<span><span class="op">)</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">D</span></span>
<span><span class="va">L_0</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">L</span></span>
<span><span class="va">S_0</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">S</span></span>
<span><span class="va">Z_0</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Z</span></span></code></pre></div>
<p>The rank of a matrix is the number of linearly independent columns or
rows in the matrix governing the structure of the data. It can
intuitively be thought of as the number of inherent latent patterns in
the data. The <code><a href="../reference/matrix_rank.html">matrix_rank()</a></code> function estimates the rank of
a given matrix by counting the number of nonzero singular values
governing that matrix:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/matrix_rank.html">matrix_rank</a></span><span class="op">(</span><span class="va">L_0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="fu"><a href="../reference/matrix_rank.html">matrix_rank</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10</span></span></code></pre></div>
<p>Here we can see <code>L_0</code> has 3 underlying patterns. This is
obscured in the observed, full-rank mixture matrix <code>D</code>, since
the <code>S_0</code> and <code>Z</code> components are corrupting the
underlying structure provided by <code>L_0</code>.</p>
<p>Because our mixtures data is often incomplete in practice, let’s
further corrupt a random 5% of the values as missing <code>NA</code>
with the <code><a href="../reference/corrupt_mat_randomly.html">corrupt_mat_randomly()</a></code> function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corrupted_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/corrupt_mat_randomly.html">corrupt_mat_randomly</a></span><span class="op">(</span><span class="va">D</span>, perc <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">D_tilde</span> <span class="op">&lt;-</span> <span class="va">corrupted_data</span><span class="op">$</span><span class="va">D_tilde</span></span>
<span><span class="va">D_tilde_imputed</span> <span class="op">&lt;-</span> <span class="va">D_tilde</span></span>
<span><span class="va">D_tilde_imputed</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">D_tilde</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>The <code>D_tilde</code> matrix represents our observed, messy
mixtures model, suffering from incomplete <code>NA</code> observations.
In a moment we will run our PCP model on <code>D_tilde</code> directly.
The <code>D_tilde_imputed</code> matrix imputes <code>NA</code> values
with <code>0</code>, allowing us to call functions that do not support
missing <code>NA</code> values.</p>
</div>
<div class="section level3">
<h3 id="pcp-model-selection">PCP model selection<a class="anchor" aria-label="anchor" href="#pcp-model-selection"></a>
</h3>
<p>There are two PCP algorithms shipped with <code>pcpr</code>: the
convex <code><a href="../reference/root_pcp.html">root_pcp()</a></code> [<a href="https://proceedings.neurips.cc/paper/2021/hash/f65854da4622c1f1ad4ffeb361d7703c-Abstract.html" class="external-link">Zhang
et al. (2021)</a>] and non-convex <code><a href="../reference/rrmc.html">rrmc()</a></code> [<a href="https://proceedings.mlr.press/v70/cherapanamjeri17a.html" class="external-link">Cherapanamjeri
et al. (2017)</a>]. To figure out which model would be best for our
data, let’s inspect the singular values of our observed mixture using
the <code><a href="../reference/sing.html">sing()</a></code> method:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">singular_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sing.html">sing</a></span><span class="op">(</span><span class="va">D_tilde_imputed</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">singular_values</span>, type <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span></span></code></pre></div>
<p><img src="quickstart-sim-example_files/figure-html/sing-1.png" width="700"></p>
<p><code><a href="../reference/rrmc.html">rrmc()</a></code> is best suited for data characterized by slowly
decaying singular values, indicative of complex underlying patterns and
a relatively large degree of noise. Most EH data can be described this
way. <code><a href="../reference/root_pcp.html">root_pcp()</a></code> is best for data characterized by rapidly
decaying singular values, indicative of very well-defined latent
patterns.</p>
<p>For a simple example like the above, both PCP models are perfectly
suitable. We will use <code><a href="../reference/rrmc.html">rrmc()</a></code>, as this is the model
environmental health researchers will likely employ most frequently.</p>
</div>
<div class="section level3">
<h3 id="tuning-pcp-parameters-via-grid-search">Tuning PCP parameters via grid search<a class="anchor" aria-label="anchor" href="#tuning-pcp-parameters-via-grid-search"></a>
</h3>
<p>To estimate the low-rank and sparse matrices, <code><a href="../reference/rrmc.html">rrmc()</a></code>
needs to be given a maximum rank <code>r</code> and regularization
parameter <code>eta</code>. To determine the optimal values of
<code>r</code> and <code>eta</code>, we will conduct a brief grid search
using the <code><a href="../reference/grid_search_cv.html">grid_search_cv()</a></code> function. In our grid search
below, we will examine all models from ranks 1 through 5 and all values
of <code>eta</code> near the default, calculated with
<code><a href="../reference/get_pcp_defaults.html">get_pcp_defaults()</a></code>.</p>
<p>The <code><a href="../reference/rrmc.html">rrmc()</a></code> approach to PCP uses an iterative rank-based
procedure to recover <code>L</code> and <code>S</code>, meaning it first
constructs a rank <code>1</code> model and iteratively builds up to the
specified rank <code>r</code> solution. As such, for our grid search
with <code><a href="../reference/grid_search_cv.html">grid_search_cv()</a></code>, we pass <code>etas</code> as the
<code>grid</code> argument we are searching and we send <code>r</code> =
5 as a constant parameter common to all models in the search. Since
<code>length(etas) = 6</code> and <code>r</code> = 5, we are grid
searching through 30 different PCP models. The <code>num_runs</code>
argument in <code><a href="../reference/grid_search_cv.html">grid_search_cv()</a></code> determines how many (random)
tests should be performed for each unique model setting. By default,
<code>num_runs = 100</code>, so our grid search tunes <code>r</code> and
<code>eta</code> by measuring the performance of 300 different PCP
models.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eta_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_pcp_defaults.html">get_pcp_defaults</a></span><span class="op">(</span><span class="va">D_tilde</span><span class="op">)</span><span class="op">$</span><span class="va">eta</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Default eta value: "</span>, <span class="va">eta_0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Default eta value:  0.0447213595499958</span></span>
<span><span class="va">etas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"eta"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span> <span class="op">*</span> <span class="va">eta_0</span>, <span class="va">eta_0</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/grid_search_cv.html">grid_search_cv</a></span><span class="op">(</span><span class="va">D_tilde</span>, pcp_fn <span class="op">=</span> <span class="va">rrmc</span>, grid <span class="op">=</span> <span class="va">etas</span>, r <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Initializing gridsearch...</span></span>
<span><span class="co">#&gt; The completed gridsearch will NOT be saved to any files, but simply returned.</span></span>
<span><span class="co">#&gt; Beginning parallel gridsearch using 4 cores and a multisession strategy...</span></span>
<span><span class="co">#&gt; Start time: 2025-03-20 01:24:50.772142</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Gridsearch completed at time: 2025-03-20 01:25:53.047976</span></span>
<span><span class="co">#&gt; Metrics calculations complete.</span></span>
<span><span class="va">r_star</span> <span class="op">&lt;-</span> <span class="va">gs</span><span class="op">$</span><span class="va">summary_stats</span><span class="op">$</span><span class="va">r</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">eta_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">gs</span><span class="op">$</span><span class="va">summary_stats</span><span class="op">$</span><span class="va">eta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gs</span><span class="op">$</span><span class="va">summary_stats</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;     eta     r rel_err L_rank S_sparsity iterations run_error_perc</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 0.224     3   0.135   3          98.9        <span style="color: #BB0000;">NaN</span> 0%            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 0.313     3   0.137   3          99.0        <span style="color: #BB0000;">NaN</span> 0%            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 0.134     3   0.143   3          31.8        <span style="color: #BB0000;">NaN</span> 0%            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 0.134     4   0.143   3.03       30.8        <span style="color: #BB0000;">NaN</span> 0%            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 0.134     5   0.143   3.03       30.8        <span style="color: #BB0000;">NaN</span> 0%            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 0.224     4   0.155   4          99.0        <span style="color: #BB0000;">NaN</span> 0%</span></span></code></pre></div>
<p>Inspecting the <code>summary_stats</code> table from the output grid
search provides the mean aggregated statistics for each of the 30
distinct parameter settings we tested. The grid search correctly
identified the rank 3 solution as the best (lowest relative error rate).
The corresponding <code>eta</code> = 0.224.</p>
</div>
<div class="section level3">
<h3 id="running-pcp">Running PCP<a class="anchor" aria-label="anchor" href="#running-pcp"></a>
</h3>
<p>Now we can run our PCP model:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcp_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rrmc.html">rrmc</a></span><span class="op">(</span><span class="va">D_tilde</span>, r <span class="op">=</span> <span class="va">r_star</span>, eta <span class="op">=</span> <span class="va">eta_star</span><span class="op">)</span></span></code></pre></div>
<p>Let’s briefly inspect PCP’s estimate of the sparse matrix
<code>S</code>, and fix any values that are “practically” zero using the
<code><a href="../reference/hard_threshold.html">hard_threshold()</a></code> function. The histogram below shows a
majority of the entries in <code>S</code> are between -0.2 and 0.2, so
we will call those values “practically” zero, and the rest true outlying
exposure events.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">pcp_model</span><span class="op">$</span><span class="va">S</span><span class="op">)</span></span></code></pre></div>
<p><img src="quickstart-sim-example_files/figure-html/sparse-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcp_model</span><span class="op">$</span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hard_threshold.html">hard_threshold</a></span><span class="op">(</span><span class="va">pcp_model</span><span class="op">$</span><span class="va">S</span>, thresh <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="benchmarking-with-pca">Benchmarking with PCA<a class="anchor" aria-label="anchor" href="#benchmarking-with-pca"></a>
</h3>
<p>Before evaluating our PCP model, let’s see how well a more
traditional method such as Principal Compoenents Analysis (PCA) can
recover <code>L_0</code>, to provide a benchmark for comparison.</p>
<p>The <code><a href="../reference/proj_rank_r.html">proj_rank_r()</a></code> function (project matrix to rank
<code>r</code>) approximates an input matrix as low-rank using a
rank-<code>r</code> truncated SVD, the same way PCA approximates a
low-rank matrix. Normally, a researcher would need to determine
<code>r</code> subjectively. We will give PCA an advantage by sharing
PCP’s discovery from the above grid search that the solution should be
of rank 3:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">L_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/proj_rank_r.html">proj_rank_r</a></span><span class="op">(</span><span class="va">D_tilde_imputed</span>, r <span class="op">=</span> <span class="va">r_star</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="evaluating-pcp-against-the-ground-truth">Evaluating PCP against the ground truth<a class="anchor" aria-label="anchor" href="#evaluating-pcp-against-the-ground-truth"></a>
</h3>
<p>Finally, let’s see how we did in recovering <code>L_0</code> and
<code>S_0</code>. We will examine the relative error between our model’s
estimates and the simulated ground truth matrices. We use the Frobenius
norm to calculate the relative errors between the matrices:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  <span class="st">"Obs_rel_err"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">L_0</span> <span class="op">-</span> <span class="va">D_tilde_imputed</span>, <span class="st">"F"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">L_0</span>, <span class="st">"F"</span><span class="op">)</span>,</span>
<span>  <span class="st">"PCA_L_rel_err"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">L_0</span> <span class="op">-</span> <span class="va">L_pca</span>, <span class="st">"F"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">L_0</span>, <span class="st">"F"</span><span class="op">)</span>,</span>
<span>  <span class="st">"PCP_L_rel_err"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">L_0</span> <span class="op">-</span> <span class="va">pcp_model</span><span class="op">$</span><span class="va">L</span>, <span class="st">"F"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">L_0</span>, <span class="st">"F"</span><span class="op">)</span>,</span>
<span>  <span class="st">"PCP_S_rel_err"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">S_0</span> <span class="op">-</span> <span class="va">pcp_model</span><span class="op">$</span><span class="va">S</span>, <span class="st">"F"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="va">S_0</span>, <span class="st">"F"</span><span class="op">)</span>,</span>
<span>  <span class="st">"PCP_L_rank"</span> <span class="op">=</span> <span class="fu"><a href="../reference/matrix_rank.html">matrix_rank</a></span><span class="op">(</span><span class="va">pcp_model</span><span class="op">$</span><span class="va">L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   Obs_rel_err PCA_L_rel_err PCP_L_rel_err PCP_S_rel_err PCP_L_rank</span></span>
<span><span class="co">#&gt; 1   0.2944351     0.2340244    0.03337159    0.05924514          3</span></span></code></pre></div>
<p>PCP outperformed PCA by quite a bit! PCP’s relative recovery error on
the <code>L_0</code> matrix stood at only 3.34%, compared to an observed
relative error of 29.44% and PCA’s relative error of 23.4%. PCP’s sparse
matrix estimate was only off from the ground truth <code>S_0</code> by
5.92%.</p>
<p>We can now pair our estimated <code>L</code> matrix with any matrix
factorization method of our choice (e.g. factor analysis or non-negative
matrix factorization, NMF) to extract the latent chemical exposure
patterns. These patterns, along with the isolated outlying exposure
events in <code>S</code>, can then be incorporated with any outcomes of
interest in downstream epidemiological analyses.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Lawrence G. Chillrud, Jaime Benavides, Elizabeth A. Gibson, Junhui Zhang, Jingkai Yan, John N. Wright, Jeff Goldsmith, Marianthi-Anna Kioumourtzoglou.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
